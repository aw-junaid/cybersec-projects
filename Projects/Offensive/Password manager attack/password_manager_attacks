#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

#define MAX_ENTRIES 100
#define MAX_PASSWORD_LENGTH 100
#define MAX_USERNAME_LENGTH 100
#define MAX_URL_LENGTH 200

typedef struct {
    char title[100];
    char username[MAX_USERNAME_LENGTH];
    char password[MAX_PASSWORD_LENGTH];
    char url[MAX_URL_LENGTH];
    char category[50];
} PasswordEntry;

typedef struct {
    PasswordEntry entries[MAX_ENTRIES];
    int count;
    char master_password[MAX_PASSWORD_LENGTH];
} PasswordVault;

void initialize_vault(PasswordVault *vault) {
    vault->count = 0;
    strcpy(vault->master_password, "default123");
}

void add_entry(PasswordVault *vault, const char *title, const char *username, 
               const char *password, const char *url, const char *category) {
    if (vault->count >= MAX_ENTRIES) {
        printf("Vault is full!\n");
        return;
    }
    
    PasswordEntry *entry = &vault->entries[vault->count];
    strncpy(entry->title, title, sizeof(entry->title));
    strncpy(entry->username, username, sizeof(entry->username));
    strncpy(entry->password, password, sizeof(entry->password));
    strncpy(entry->url, url, sizeof(entry->url));
    strncpy(entry->category, category, sizeof(entry->category));
    
    vault->count++;
}

int is_weak_password(const char *password) {
    const char *common_passwords[] = {
        "password", "123456", "password123", "admin", "qwerty",
        "letmein", "welcome", "123456789", "12345678", "12345",
        NULL
    };
    
    // Check against common passwords
    for (int i = 0; common_passwords[i] != NULL; i++) {
        if (strcmp(password, common_passwords[i]) == 0) {
            return 1;
        }
    }
    
    // Check length
    if (strlen(password) < 8) {
        return 1;
    }
    
    // Check for common patterns
    if (strstr(password, "123") != NULL || 
        strstr(password, "abc") != NULL ||
        strstr(password, "qwe") != NULL) {
        return 1;
    }
    
    return 0;
}

void analyze_vault_security(PasswordVault *vault) {
    printf("\n=== VAULT SECURITY ANALYSIS ===\n");
    
    int weak_passwords = 0;
    int empty_passwords = 0;
    
    printf("Total entries: %d\n", vault->count);
    
    // Analyze master password
    if (is_weak_password(vault->master_password)) {
        printf("[CRITICAL] Weak master password detected: %s\n", vault->master_password);
    } else {
        printf("[OK] Master password appears strong\n");
    }
    
    // Analyze individual passwords
    for (int i = 0; i < vault->count; i++) {
        PasswordEntry *entry = &vault->entries[i];
        
        if (strlen(entry->password) == 0) {
            empty_passwords++;
            printf("[HIGH] Empty password for: %s\n", entry->title);
        } else if (is_weak_password(entry->password)) {
            weak_passwords++;
            printf("[MEDIUM] Weak password for %s: %s\n", entry->title, entry->password);
        }
    }
    
    printf("\nSecurity Summary:\n");
    printf("Weak passwords: %d/%d\n", weak_passwords, vault->count);
    printf("Empty passwords: %d/%d\n", empty_passwords, vault->count);
    
    float security_score = 100.0;
    security_score -= ((float)weak_passwords / vault->count) * 50;
    security_score -= ((float)empty_passwords / vault->count) * 100;
    
    if (security_score < 0) security_score = 0;
    
    printf("Overall Security Score: %.1f/100\n", security_score);
}

void simulate_export_attack(PasswordVault *vault) {
    printf("\n=== EXPORT SECURITY TEST ===\n");
    
    printf("Simulating CSV export...\n");
    printf("title,username,password,url,category\n");
    
    for (int i = 0; i < vault->count; i++) {
        PasswordEntry *entry = &vault->entries[i];
        printf("%s,%s,%s,%s,%s\n", 
               entry->title, entry->username, entry->password, 
               entry->url, entry->category);
    }
    
    printf("\n[!] WARNING: Plaintext export exposes all credentials!\n");
    printf("[+] Recommendation: Use encrypted exports only\n");
}

void simulate_memory_analysis(PasswordVault *vault) {
    printf("\n=== MEMORY ANALYSIS SIMULATION ===\n");
    
    printf("Scanning simulated memory for passwords...\n");
    
    int found_passwords = 0;
    for (int i = 0; i < vault->count; i++) {
        // Simulate finding some passwords in memory
        if (rand() % 100 < 40) {  // 40% chance per entry
            printf("[FOUND] Password in memory: %s - %s\n", 
                   vault->entries[i].title, vault->entries[i].password);
            found_passwords++;
        }
    }
    
    printf("Total passwords found in memory: %d/%d\n", found_passwords, vault->count);
    printf("[+] Recommendation: Use memory-protected password managers\n");
}

void demonstrate_common_attacks() {
    printf("\n=== COMMON PASSWORD MANAGER ATTACKS ===\n");
    
    printf("\n1. Export File Attacks:\n");
    printf("   - Plaintext CSV/JSON exports\n");
    printf("   - Weak encryption on encrypted exports\n");
    printf("   - Metadata exposure in exports\n");
    
    printf("\n2. Memory Analysis:\n");
    printf("   - Process memory dumping\n");
    printf("   - RAM scraping\n");
    printf("   - Pagefile analysis\n");
    
    printf("\n3. Master Password Attacks:\n");
    printf("   - Brute force attacks\n");
    printf("   - Password spraying\n");
    printf("   - Social engineering\n");
    
    printf("\n4. Sync and Backup Attacks:\n");
    printf("   - Cloud synchronization interception\n");
    printf("   - Local backup file access\n");
    printf("   - Conflict resolution vulnerabilities\n");
}

void show_defense_recommendations() {
    printf("\n=== DEFENSE RECOMMENDATIONS ===\n");
    
    printf("\n1. Strong Master Password:\n");
    printf("   - Use 16+ characters with complexity\n");
    printf("   - Avoid dictionary words and patterns\n");
    printf("   - Use passphrases for memorability\n");
    
    printf("\n2. Export Security:\n");
    printf("   - Always use encrypted exports\n");
    printf("   - Delete export files immediately after use\n");
    printf("   - Verify encryption strength\n");
    
    printf("\n3. Memory Protection:\n");
    printf("   - Use managers with memory protection\n");
    printf("   - Clear clipboard immediately\n");
    printf("   - Lock manager when not in use\n");
    
    printf("\n4. General Security:\n");
    printf("   - Enable two-factor authentication\n");
    printf("   - Regular security audits\n");
    printf("   - Keep software updated\n");
    printf("   - Use built-in password generator\n");
}

int main() {
    srand(time(NULL));
    
    printf("Password Manager Attack Simulator\n");
    printf("=================================\n");
    printf("FOR SECURITY TESTING AND EDUCATION ONLY\n\n");
    
    PasswordVault vault;
    initialize_vault(&vault);
    
    // Add sample entries
    add_entry(&vault, "Gmail", "user@gmail.com", "password123", 
              "https://gmail.com", "Email");
    add_entry(&vault, "Bank", "john_doe", "Str0ngP@ss!2024", 
              "https://bank.example.com", "Finance");
    add_entry(&vault, "Facebook", "johndoe", "facebook123", 
              "https://facebook.com", "Social");
    add_entry(&vault, "GitHub", "dev_user", "G1tHubS3cur3!", 
              "https://github.com", "Development");
    
    analyze_vault_security(&vault);
    simulate_export_attack(&vault);
    simulate_memory_analysis(&vault);
    
    demonstrate_common_attacks();
    show_defense_recommendations();
    
    printf("\n=== LEGAL AND ETHICAL USAGE ===\n");
    printf("This tool is for:\n");
    printf("  ✅ Authorized security testing\n");
    printf("  ✅ Password manager evaluation\n");
    printf("  ✅ Security awareness training\n");
    printf("  ✅ Defensive security research\n");
    printf("\nProhibited uses:\n");
    printf("  ❌ Unauthorized system access\n");
    printf("  ❌ Malicious attacks\n");
    printf("  ❌ Password cracking without permission\n");
    
    return 0;
}
