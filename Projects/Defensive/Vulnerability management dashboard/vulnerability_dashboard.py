#!/usr/bin/env python3
"""
Vulnerability Management Dashboard
Track findings through their complete lifecycle
"""

import json
import datetime
from dataclasses import dataclass, asdict
from typing import List, Dict, Optional
from enum import Enum

class VulnerabilityStatus(Enum):
    NEW = "New"
    IN_PROGRESS = "In Progress"
    RESOLVED = "Resolved"
    FALSE_POSITIVE = "False Positive"
    RISK_ACCEPTED = "Risk Accepted"

class SeverityLevel(Enum):
    CRITICAL = "Critical"
    HIGH = "High"
    MEDIUM = "Medium"
    LOW = "Low"
    INFO = "Informational"

@dataclass
class Vulnerability:
    id: str
    title: str
    description: str
    severity: SeverityLevel
    status: VulnerabilityStatus
    asset: str
    discovered_date: str
    due_date: Optional[str]
    assigned_to: str
    cvss_score: float
    proof: str
    remediation: str
    last_updated: str

class VulnerabilityDashboard:
    def __init__(self, data_file="vulnerabilities.json"):
        self.data_file = data_file
        self.vulnerabilities: List[Vulnerability] = []
        self.load_data()
    
    def load_data(self):
        """Load vulnerability data from JSON file"""
        try:
            with open(self.data_file, 'r') as f:
                data = json.load(f)
                for vuln_data in data:
                    vuln = Vulnerability(
                        id=vuln_data['id'],
                        title=vuln_data['title'],
                        description=vuln_data['description'],
                        severity=SeverityLevel(vuln_data['severity']),
                        status=VulnerabilityStatus(vuln_data['status']),
                        asset=vuln_data['asset'],
                        discovered_date=vuln_data['discovered_date'],
                        due_date=vuln_data.get('due_date'),
                        assigned_to=vuln_data['assigned_to'],
                        cvss_score=vuln_data['cvss_score'],
                        proof=vuln_data['proof'],
                        remediation=vuln_data['remediation'],
                        last_updated=vuln_data['last_updated']
                    )
                    self.vulnerabilities.append(vuln)
        except FileNotFoundError:
            self.vulnerabilities = []
    
    def save_data(self):
        """Save vulnerability data to JSON file"""
        data = []
        for vuln in self.vulnerabilities:
            vuln_dict = asdict(vuln)
            vuln_dict['severity'] = vuln.severity.value
            vuln_dict['status'] = vuln.status.value
            data.append(vuln_dict)
        
        with open(self.data_file, 'w') as f:
            json.dump(data, f, indent=2)
    
    def add_vulnerability(self, title, description, severity, asset, assigned_to, cvss_score, proof, remediation):
        """Add a new vulnerability to the dashboard"""
        vuln_id = f"VULN-{len(self.vulnerabilities) + 1:04d}"
        current_date = datetime.datetime.now().strftime("%Y-%m-%d")
        
        vuln = Vulnerability(
            id=vuln_id,
            title=title,
            description=description,
            severity=SeverityLevel(severity),
            status=VulnerabilityStatus.NEW,
            asset=asset,
            discovered_date=current_date,
            due_date=None,
            assigned_to=assigned_to,
            cvss_score=cvss_score,
            proof=proof,
            remediation=remediation,
            last_updated=current_date
        )
        
        self.vulnerabilities.append(vuln)
        self.save_data()
        return vuln_id
    
    def update_status(self, vuln_id: str, new_status: VulnerabilityStatus, notes: str = ""):
        """Update the status of a vulnerability"""
        for vuln in self.vulnerabilities:
            if vuln.id == vuln_id:
                vuln.status = new_status
                vuln.last_updated = datetime.datetime.now().strftime("%Y-%m-%d")
                if notes:
                    vuln.remediation += f"\nUpdate: {notes}"
                self.save_data()
                return True
        return False
    
    def get_vulnerabilities_by_status(self, status: Optional[VulnerabilityStatus] = None):
        """Get vulnerabilities filtered by status"""
        if status:
            return [v for v in self.vulnerabilities if v.status == status]
        return self.vulnerabilities
    
    def get_statistics(self) -> Dict:
        """Get dashboard statistics"""
        stats = {
            'total': len(self.vulnerabilities),
            'by_severity': {},
            'by_status': {}
        }
        
        for severity in SeverityLevel:
            stats['by_severity'][severity.value] = len(
                [v for v in self.vulnerabilities if v.severity == severity]
            )
        
        for status in VulnerabilityStatus:
            stats['by_status'][status.value] = len(
                [v for v in self.vulnerabilities if v.status == status]
            )
        
        return stats
    
    def display_dashboard(self):
        """Display the vulnerability dashboard"""
        stats = self.get_statistics()
        
        print("\n" + "="*80)
        print("VULNERABILITY MANAGEMENT DASHBOARD")
        print("="*80)
        
        print(f"\nOVERVIEW:")
        print(f"Total Vulnerabilities: {stats['total']}")
        print(f"Critical: {stats['by_severity']['Critical']} | "
              f"High: {stats['by_severity']['High']} | "
              f"Medium: {stats['by_severity']['Medium']} | "
              f"Low: {stats['by_severity']['Low']}")
        
        print(f"\nSTATUS DISTRIBUTION:")
        for status, count in stats['by_status'].items():
            print(f"  {status}: {count}")
        
        print(f"\nRECENT VULNERABILITIES:")
        print("-"*80)
        print(f"{'ID':<10} {'Title':<25} {'Severity':<12} {'Status':<15} {'Assigned To':<15}")
        print("-"*80)
        
        for vuln in self.vulnerabilities[-10:]:  # Show last 10
            print(f"{vuln.id:<10} {vuln.title:<25} {vuln.severity.value:<12} "
                  f"{vuln.status.value:<15} {vuln.assigned_to:<15}")

def main():
    dashboard = VulnerabilityDashboard()
    
    while True:
        dashboard.display_dashboard()
        
        print("\nACTIONS:")
        print("1. Add New Vulnerability")
        print("2. Update Vulnerability Status")
        print("3. View All Vulnerabilities")
        print("4. View by Status")
        print("5. Exit")
        
        choice = input("\nSelect action (1-5): ").strip()
        
        if choice == "1":
            print("\nAdd New Vulnerability:")
            title = input("Title: ")
            description = input("Description: ")
            print("Severity levels: Critical, High, Medium, Low, Informational")
            severity = input("Severity: ")
            asset = input("Affected Asset: ")
            assigned_to = input("Assigned To: ")
            cvss_score = float(input("CVSS Score: "))
            proof = input("Proof/Evidence: ")
            remediation = input("Recommended Remediation: ")
            
            vuln_id = dashboard.add_vulnerability(
                title, description, severity, asset, assigned_to, 
                cvss_score, proof, remediation
            )
            print(f"Vulnerability added with ID: {vuln_id}")
        
        elif choice == "2":
            vuln_id = input("Enter Vulnerability ID: ")
            print("Available statuses: New, In Progress, Resolved, False Positive, Risk Accepted")
            new_status = input("New Status: ")
            
            if dashboard.update_status(vuln_id, VulnerabilityStatus(new_status)):
                print("Status updated successfully!")
            else:
                print("Vulnerability not found!")
        
        elif choice == "3":
            print("\nALL VULNERABILITIES:")
            for vuln in dashboard.vulnerabilities:
                print(f"\nID: {vuln.id}")
                print(f"Title: {vuln.title}")
                print(f"Severity: {vuln.severity.value} (CVSS: {vuln.cvss_score})")
                print(f"Status: {vuln.status.value}")
                print(f"Asset: {vuln.asset}")
                print(f"Discovered: {vuln.discovered_date}")
                print(f"Assigned To: {vuln.assigned_to}")
                print("-" * 40)
        
        elif choice == "4":
            print("Status to filter by: New, In Progress, Resolved, False Positive, Risk Accepted")
            status_filter = input("Enter status: ")
            filtered = dashboard.get_vulnerabilities_by_status(VulnerabilityStatus(status_filter))
            
            print(f"\nVULNERABILITIES WITH STATUS: {status_filter}")
            for vuln in filtered:
                print(f"{vuln.id}: {vuln.title} - {vuln.severity.value}")
        
        elif choice == "5":
            print("Goodbye!")
            break
        
        else:
            print("Invalid choice!")

if __name__ == "__main__":
    main()
