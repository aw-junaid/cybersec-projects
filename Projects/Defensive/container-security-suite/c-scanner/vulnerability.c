/**
 * Vulnerability database and checking functions
 */

#include "vulnerability.h"
#include <string.h>
#include <stdio.h>

// Simple in-memory vulnerability database
typedef struct {
    const char* cve_id;
    const char* package;
    const char* severity;
    int score;
} vulnerability_t;

static vulnerability_t vuln_db[] = {
    {"CVE-2021-44228", "log4j", "CRITICAL", 10},
    {"CVE-2021-45046", "log4j", "HIGH", 8},
    {"CVE-2019-1010218", "glibc", "MEDIUM", 5},
    {"CVE-2018-12886", "gcc", "MEDIUM", 5},
    {NULL, NULL, NULL, 0} // Sentinel
};

int check_package_vulnerabilities(const char* package_name, 
                                 const char* version,
                                 vulnerability_t** found_vulns) {
    int count = 0;
    vulnerability_t* vuln_ptr = vuln_db;
    
    // Count matching vulnerabilities
    while (vuln_ptr->cve_id != NULL) {
        if (strstr(package_name, vuln_ptr->package) != NULL) {
            count++;
        }
        vuln_ptr++;
    }
    
    if (count == 0) {
        *found_vulns = NULL;
        return 0;
    }
    
    // Allocate and populate results
    *found_vulns = malloc(count * sizeof(vulnerability_t));
    vuln_ptr = vuln_db;
    int index = 0;
    
    while (vuln_ptr->cve_id != NULL) {
        if (strstr(package_name, vuln_ptr->package) != NULL) {
            (*found_vulns)[index] = *vuln_ptr;
            index++;
        }
        vuln_ptr++;
    }
    
    return count;
}

void free_vulnerabilities(vulnerability_t* vulns) {
    if (vulns) {
        free(vulns);
    }
}
